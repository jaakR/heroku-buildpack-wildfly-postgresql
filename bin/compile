#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# versions
POSTGRESQL_VERSION="42.2.1"
POSTGRESQL_SHA1="b7f61848ac43ae9fa6e38935bfd75628b7fc9086"

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BIN_DIR=$BP_DIR/bin

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

cd $BUILD_DIR

export_env_dir() {
  env_dir=$1
  whitelist_regex=${2:-'^(DATABASE_URL)}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}
export_env_dir

JBOSS_HOME=$BUILD_DIR/.jboss/wildfly-11.0.0.Final

: "${JBOSS_HOME:?You need to install Wildfly first. JBOSS_HOME environment variable not found.}"

echo "-----> Downloading postgresql connector from http://central.maven.org/maven2/org.postgresql/postgresql/${POSTGRESQL_VERSION}/postgresql-${POSTGRESQL_VERSION}.jar ... "
curl -O http://central.maven.org/maven2/org/postgresql/postgresql/${POSTGRESQL_VERSION}/postgresql-${POSTGRESQL_VERSION}.jar          
echo "-----> downloaded"
sha1sum postgresql-${POSTGRESQL_VERSION}.jar | grep $POSTGRESQL_SHA1 > /dev/null 2>&1
echo "-----> verified"

# 1) startup
echo "-----> Starting WildFly ... "
$JBOSS_HOME/bin/standalone.sh --admin-only &

WILDFLY_RUNNING=1

until [ $WILDFLY_RUNNING -eq 0 ]; do
	$JBOSS_HOME/bin/jboss-cli.sh --connect --command=":read-attribute(name=server-state)"
	WILDFLY_RUNNING=$?
	sleep 3
done	

# 2) create postgresql module
echo "-----> create postgresql module ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect --command="module add --name=org.postgresql --resources=$BUILD_DIR/postgresql-$POSTGRESQL_VERSION.jar --dependencies=javax.api,javax.transaction.api"

# 3) install driver
echo "-----> install JDBC driver ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect --command="/subsystem=datasources/jdbc-driver=postgresql:add(driver-name=postgresql,driver-module-name=org.postgresql,driver-xa-datasource-class-name=org.postgresql.xa.PGXADataSource)"

$JBOSS_HOME/bin/jboss-cli.sh --connect --command="/subsystem=datasources:installed-drivers-list"

# 4) install datasource
echo "-----> install data source ... "
echo "-----> export required env vars ... "

echo "$(ls /tmp/d20190808-63-166c78p)"
echo $DATABASE_URL
proto="$(echo $DATABASE_URL | grep :// | sed -e's,^\(.*://\).*,\1,g')"
# remove the protocol
url="$(echo ${1/$proto/})"
# extract the user (if any)
PGUSER="$(echo $url | grep @ | cut -d@ -f1)"
PGPASSWORD="$(echo $userpass | grep : | cut -d: -f2)"
if [ -n "$pass" ]; then
  user="$(echo $userpass | grep : | cut -d: -f1)"
else
    user=$userpass
fi

# extract the host
PGHOST="$(echo ${url/$user@/} | cut -d/ -f1)"
# by request - try to extract the port
PGPORT="$(echo $host | sed -e 's,^.*:,:,g' -e 's,.*:\([0-9]*\).*,\1,g' -e 's,[^0-9],,g')"
# extract the path (if any)
PGPATH="$(echo $url | grep / | cut -d/ -f2-)"

echo "url: $url"
echo "  proto: $proto"
echo "  user: $user"
echo "  pass: $pass"
echo "  host: $host"
echo "  port: $port"
echo "  path: $path"

for KEY in PGUSER PGPASSWORD PGHOST PGDATABASE; do
  [ -f $ENV_DIR/$KEY ] && export "$KEY=$(cat $ENV_DIR/$KEY)"
  [ -z "${!KEY}" ] && echo "You didn't set $KEY, and this is required." && exit 1
done

$JBOSS_HOME/bin/jboss-cli.sh --connect --command="data-source add --name=smartIDDataSource --driver-name=postgresql --jndi-name=java:/smartIDDataSource --driver-class=org.postgresql.Driver --user-name=$PGUSER --password=$PGPASSWORD --connection-url=jdbc:postgresql://$PGHOST:5432/$PGDATABASE"

# 5) shutdown
echo "-----> shutdown WildFly ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect command=:shutdown

echo "-----> done"